# Diagrama de Flujo: `/invoices/process-from-url`

**Endpoint:** `POST /api/v4/invoices/process-from-url`  
**Estado:** âš ï¸ ImplementaciÃ³n actual NO funcional (ver problema en lÃ­nea 98)

---

## ğŸ“Š FLUJO COMPLETO - DIAGRAMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE / FRONTEND                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ POST /api/v4/invoices/process-from-url
                                 â”‚ Headers: Authorization: Bearer <JWT>
                                 â”‚ Body: {
                                 â”‚   "url": "https://dgi-fep.mef.gob.pa/...",
                                 â”‚   "type": "QR",              â† âŒ FALTA
                                 â”‚   "origin": "app",           â† âŒ FALTA
                                 â”‚   "user_email": "...",       â† âŒ FALTA
                                 â”‚   ...
                                 â”‚ }
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MIDDLEWARE LAYER                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Authentication (JWT)        â†’ Extrae user_id                    â”‚
â”‚  2. Idempotency Check          â†’ Valida Idempotency-Key             â”‚
â”‚  3. Rate Limiting              â†’ Valida lÃ­mites por Trust Score     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               HANDLER: process_url_handler()                        â”‚
â”‚               Archivo: src/api/url_processing_v4.rs                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. Validar URL no vacÃ­a                                            â”‚
â”‚  2. Generar request_id (UUID)                                       â”‚
â”‚  3. Iniciar timer (para execution_time_ms)                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WEB SCRAPING LAYER                                  â”‚
â”‚          FunciÃ³n: scrape_invoice(client, url)                       â”‚
â”‚          Archivo: src/api/webscraping/mod.rs                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 1: Fetch HTML                                     â”‚        â”‚
â”‚  â”‚ â€¢ GET request a la URL                                 â”‚        â”‚
â”‚  â”‚ â€¢ Sigue redirects automÃ¡ticamente                      â”‚        â”‚
â”‚  â”‚ â€¢ Captura URL final                                    â”‚        â”‚
â”‚  â”‚ â€¢ Descarga contenido HTML (promedio: 50KB)             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 2: Extraer CUFE                                   â”‚        â”‚
â”‚  â”‚ â€¢ Busca parÃ¡metro chFE= en URL final                   â”‚        â”‚
â”‚  â”‚ â€¢ Ejemplo: chFE=FE01200002679...                       â”‚        â”‚
â”‚  â”‚ â€¢ Fallback: "UNKNOWN"                                  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 3: Parsear HTML con scraper::Html                 â”‚        â”‚
â”‚  â”‚ â€¢ Crea documento DOM                                   â”‚        â”‚
â”‚  â”‚ â€¢ Prepara selectores CSS                               â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 4: Extraer Invoice Header                         â”‚        â”‚
â”‚  â”‚ FunciÃ³n: extract_invoice_header()                      â”‚        â”‚
â”‚  â”‚ Usa: extract_main_info() (ocr_extractor)               â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Campos extraÃ­dos (âœ… = funciona):                       â”‚        â”‚
â”‚  â”‚ âœ… no (nÃºmero factura)                                 â”‚        â”‚
â”‚  â”‚ âœ… date (fecha emisiÃ³n)                                â”‚        â”‚
â”‚  â”‚ âœ… issuer_name, issuer_ruc, issuer_dv                  â”‚        â”‚
â”‚  â”‚ âœ… issuer_address, issuer_phone                        â”‚        â”‚
â”‚  â”‚ âœ… receptor_name, receptor_id, receptor_dv             â”‚        â”‚
â”‚  â”‚ âœ… receptor_address, receptor_phone                    â”‚        â”‚
â”‚  â”‚ âœ… tot_amount, tot_itbms                               â”‚        â”‚
â”‚  â”‚ âŒ auth_date (NO extraÃ­do)                             â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Metadatos agregados:                                   â”‚        â”‚
â”‚  â”‚ â€¢ cufe (del PASO 2)                                    â”‚        â”‚
â”‚  â”‚ â€¢ url (URL final)                                      â”‚        â”‚
â”‚  â”‚ â€¢ origin (hardcoded "app")                             â”‚        â”‚
â”‚  â”‚ â€¢ type_field (hardcoded "QR")                          â”‚        â”‚
â”‚  â”‚ â€¢ process_date, reception_date (now())                 â”‚        â”‚
â”‚  â”‚ â€¢ user_id (hardcoded 1 âš ï¸)                             â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 5: Extraer Invoice Details                        â”‚        â”‚
â”‚  â”‚ FunciÃ³n: extract_invoice_details()                     â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âš ï¸ IMPLEMENTACIÃ“N ACTUAL: Mock/BÃ¡sica                  â”‚        â”‚
â”‚  â”‚ â€¢ Busca tablas con items                               â”‚        â”‚
â”‚  â”‚ â€¢ Retorna 1 registro de ejemplo                        â”‚        â”‚
â”‚  â”‚ â€¢ NO extrae datos reales del HTML                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 6: Extraer Invoice Payments                       â”‚        â”‚
â”‚  â”‚ FunciÃ³n: extract_invoice_payments()                    â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âš ï¸ IMPLEMENTACIÃ“N ACTUAL: Mock/BÃ¡sica                  â”‚        â”‚
â”‚  â”‚ â€¢ Busca secciÃ³n de pagos                               â”‚        â”‚
â”‚  â”‚ â€¢ Retorna 1 registro de ejemplo                        â”‚        â”‚
â”‚  â”‚ â€¢ NO extrae datos reales del HTML                      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ RETORNO: ScrapingResult                                â”‚        â”‚
â”‚  â”‚ {                                                       â”‚        â”‚
â”‚  â”‚   success: true,                                        â”‚        â”‚
â”‚  â”‚   header: InvoiceHeader { ... },                       â”‚        â”‚
â”‚  â”‚   details: Vec<InvoiceDetail>,                         â”‚        â”‚
â”‚  â”‚   payments: Vec<InvoicePayment>,                       â”‚        â”‚
â”‚  â”‚   error_message: None                                  â”‚        â”‚
â”‚  â”‚ }                                                       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DATABASE PERSISTENCE LAYER                             â”‚
â”‚        FunciÃ³n: persist_scraped_data(pool, result, url)             â”‚
â”‚        Archivo: src/api/database_persistence.rs                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 1: Verificar Duplicados                           â”‚        â”‚
â”‚  â”‚ Query: SELECT id, cufe FROM invoice_headers             â”‚        â”‚
â”‚  â”‚        WHERE cufe = $1                                  â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âŒ ERROR: Tabla "invoice_headers" no existe             â”‚        â”‚
â”‚  â”‚ âœ… DeberÃ­a ser: "invoice_header" (singular)             â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Si existe â†’ Retorna error "Duplicate"                  â”‚        â”‚
â”‚  â”‚ Si no existe â†’ ContinÃºa                                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 2: Iniciar TransacciÃ³n                            â”‚        â”‚
â”‚  â”‚ let mut tx = pool.begin().await                         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 3: Guardar Header                                 â”‚        â”‚
â”‚  â”‚ FunciÃ³n: save_invoice_header(&mut tx, &header)          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query ACTUAL (âŒ INCORRECTO):                           â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_headers (                           â”‚        â”‚
â”‚  â”‚   cufe, numero_factura, fecha_emision,                 â”‚        â”‚
â”‚  â”‚   proveedor_nombre, proveedor_ruc,                     â”‚        â”‚
â”‚  â”‚   cliente_nombre, cliente_ruc,                         â”‚        â”‚
â”‚  â”‚   subtotal, impuestos, total,                          â”‚        â”‚
â”‚  â”‚   moneda, estado, user_id, source_url                  â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âŒ ERROR SQL: Campos no existen                         â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query CORRECTA (âœ… DEBERÃA SER):                        â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_header (                            â”‚        â”‚
â”‚  â”‚   cufe, no, date, issuer_name, issuer_ruc,             â”‚        â”‚
â”‚  â”‚   issuer_dv, issuer_address, issuer_phone,             â”‚        â”‚
â”‚  â”‚   receptor_name, receptor_id, receptor_dv,             â”‚        â”‚
â”‚  â”‚   receptor_address, receptor_phone,                    â”‚        â”‚
â”‚  â”‚   tot_amount, tot_itbms, auth_date,                    â”‚        â”‚
â”‚  â”‚   url, type, origin, process_date,                     â”‚        â”‚
â”‚  â”‚   reception_date, time, user_id,                       â”‚        â”‚
â”‚  â”‚   user_email, user_phone_number,                       â”‚        â”‚
â”‚  â”‚   user_telegram_id, user_ws                            â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Campos guardados: 11 / 27 campos                       â”‚        â”‚
â”‚  â”‚ Campos faltantes: 16                                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 4: Guardar Details                                â”‚        â”‚
â”‚  â”‚ FunciÃ³n: save_invoice_details(&mut tx, &details, id)    â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query ACTUAL (âŒ INCORRECTO):                           â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_details (                           â”‚        â”‚
â”‚  â”‚   invoice_header_id, cufe, item_numero,                â”‚        â”‚
â”‚  â”‚   descripcion, cantidad, precio_unitario,              â”‚        â”‚
â”‚  â”‚   subtotal, impuesto_porcentaje,                       â”‚        â”‚
â”‚  â”‚   impuesto_monto, total                                â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âŒ ERROR SQL: Campos/tipos incorrectos                  â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query CORRECTA (âœ… DEBERÃA SER):                        â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_detail (                            â”‚        â”‚
â”‚  â”‚   cufe, partkey, date, quantity, code,                 â”‚        â”‚
â”‚  â”‚   description, unit_discount, unit_price,              â”‚        â”‚
â”‚  â”‚   itbms, amount, total,                                â”‚        â”‚
â”‚  â”‚   information_of_interest                              â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âš ï¸ Todos los campos deben ser TEXT, no Decimal          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 5: Guardar Payments                               â”‚        â”‚
â”‚  â”‚ FunciÃ³n: save_invoice_payments(&mut tx, &payments, id)  â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query ACTUAL (âŒ INCORRECTO):                           â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_payments (                          â”‚        â”‚
â”‚  â”‚   invoice_header_id, cufe,                             â”‚        â”‚
â”‚  â”‚   metodo_pago, monto, referencia                       â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âŒ ERROR SQL: Campos/tipos incorrectos                  â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Query CORRECTA (âœ… DEBERÃA SER):                        â”‚        â”‚
â”‚  â”‚ INSERT INTO invoice_payment (                           â”‚        â”‚
â”‚  â”‚   cufe, forma_de_pago, forma_de_pago_otro,             â”‚        â”‚
â”‚  â”‚   valor_pago, efectivo, tarjeta_dÃ©bito,                â”‚        â”‚
â”‚  â”‚   tarjeta_crÃ©dito, tarjeta_clave__banistmo_,           â”‚        â”‚
â”‚  â”‚   vuelto, total_pagado, descuentos, merged             â”‚        â”‚
â”‚  â”‚ ) VALUES (...)                                          â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âš ï¸ Todos los campos deben ser TEXT (excepto merged)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ PASO 6: Commit TransacciÃ³n                             â”‚        â”‚
â”‚  â”‚ tx.commit().await                                       â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âŒ ERROR: Falla por queries incorrectas                 â”‚        â”‚
â”‚  â”‚ â†’ ROLLBACK automÃ¡tico                                  â”‚        â”‚
â”‚  â”‚ â†’ NO se guarda NADA                                    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ RETORNO: Result<ProcessUrlResponse>                     â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Si Ã©xito (âœ…):                                          â”‚        â”‚
â”‚  â”‚   Ok(ProcessUrlResponse {                              â”‚        â”‚
â”‚  â”‚     success: true,                                      â”‚        â”‚
â”‚  â”‚     message: "URL processed successfully (API)",       â”‚        â”‚
â”‚  â”‚     invoice_id: Some(123),                             â”‚        â”‚
â”‚  â”‚     cufe: Some("FE01..."),                             â”‚        â”‚
â”‚  â”‚     processing_time_ms: Some(1234)                     â”‚        â”‚
â”‚  â”‚   })                                                    â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ Si error (âŒ):                                          â”‚        â”‚
â”‚  â”‚   Err(ProcessUrlResponse {                             â”‚        â”‚
â”‚  â”‚     success: false,                                     â”‚        â”‚
â”‚  â”‚     message: "Database error",                         â”‚        â”‚
â”‚  â”‚     ...                                                 â”‚        â”‚
â”‚  â”‚   })                                                    â”‚        â”‚
â”‚  â”‚                                                         â”‚        â”‚
â”‚  â”‚ âš ï¸ PROBLEMA ACTUAL: Aunque falle el insert,            â”‚        â”‚
â”‚  â”‚    puede retornar success=false pero la                â”‚        â”‚
â”‚  â”‚    extracciÃ³n dice que fue exitosa                     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HANDLER: ConstrucciÃ³n Response                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Calcula execution_time_ms (tiempo total)                           â”‚
â”‚  Genera timestamp UTC                                               â”‚
â”‚  Incluye request_id                                                 â”‚
â”‚                                                                     â”‚
â”‚  Response FINAL:                                                    â”‚
â”‚  {                                                                  â”‚
â”‚    "success": true/false,                                           â”‚
â”‚    "data": {                                                        â”‚
â”‚      "success": true/false,                                         â”‚
â”‚      "message": "...",                                              â”‚
â”‚      "process_type": "API",                                         â”‚
â”‚      "invoice_id": 123 / null,                                      â”‚
â”‚      "cufe": "FE01..." / null,                                      â”‚
â”‚      "processing_time_ms": 1234                                     â”‚
â”‚    },                                                               â”‚
â”‚    "error": null / {...},                                           â”‚
â”‚    "request_id": "uuid-...",                                        â”‚
â”‚    "timestamp": "2024-10-01T14:30:00Z",                             â”‚
â”‚    "execution_time_ms": 1234,                                       â”‚
â”‚    "cached": false                                                  â”‚
â”‚  }                                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENTE / FRONTEND                          â”‚
â”‚                                                                     â”‚
â”‚  âš ï¸ PROBLEMA ACTUAL:                                                â”‚
â”‚  â€¢ Frontend recibe "success": true                                  â”‚
â”‚  â€¢ Pero NO hay datos guardados en BD                                â”‚
â”‚  â€¢ Error SQL no se reporta al usuario                               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ ESTADO DE LA BASE DE DATOS

### Tablas Reales (PostgreSQL)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      invoice_header (27 campos)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cufe                    TEXT                                        â”‚
â”‚ no                      TEXT                                        â”‚
â”‚ date                    TIMESTAMP                                   â”‚
â”‚ issuer_name             TEXT                                        â”‚
â”‚ issuer_ruc              TEXT                                        â”‚
â”‚ issuer_dv               TEXT                                        â”‚
â”‚ issuer_address          TEXT                                        â”‚
â”‚ issuer_phone            TEXT                                        â”‚
â”‚ receptor_name           TEXT                                        â”‚
â”‚ receptor_id             TEXT                                        â”‚
â”‚ receptor_dv             TEXT                                        â”‚
â”‚ receptor_address        TEXT                                        â”‚
â”‚ receptor_phone          TEXT                                        â”‚
â”‚ tot_amount              DOUBLE PRECISION                            â”‚
â”‚ tot_itbms               DOUBLE PRECISION                            â”‚
â”‚ auth_date               TEXT                                        â”‚
â”‚ url                     VARCHAR                                     â”‚
â”‚ type                    VARCHAR                                     â”‚
â”‚ origin                  VARCHAR                                     â”‚
â”‚ process_date            TIMESTAMP WITH TIMEZONE                     â”‚
â”‚ reception_date          TIMESTAMP WITH TIMEZONE                     â”‚
â”‚ time                    TEXT                                        â”‚
â”‚ user_id                 BIGINT                                      â”‚
â”‚ user_email              TEXT                                        â”‚
â”‚ user_phone_number       TEXT                                        â”‚
â”‚ user_telegram_id        TEXT                                        â”‚
â”‚ user_ws                 VARCHAR                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–²
                                 â”‚ FK: cufe
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      invoice_detail (12 campos)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cufe                    TEXT  (FK)                                  â”‚
â”‚ partkey                 TEXT  (cufe|linea)                          â”‚
â”‚ date                    TEXT                                        â”‚
â”‚ quantity                TEXT                                        â”‚
â”‚ code                    TEXT                                        â”‚
â”‚ description             TEXT                                        â”‚
â”‚ unit_discount           TEXT                                        â”‚
â”‚ unit_price              TEXT                                        â”‚
â”‚ itbms                   TEXT                                        â”‚
â”‚ amount                  TEXT                                        â”‚
â”‚ total                   TEXT                                        â”‚
â”‚ information_of_interest TEXT                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–²
                                 â”‚ FK: cufe
                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     invoice_payment (12 campos)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cufe                       TEXT  (FK)                               â”‚
â”‚ forma_de_pago              TEXT                                     â”‚
â”‚ forma_de_pago_otro         TEXT                                     â”‚
â”‚ valor_pago                 TEXT                                     â”‚
â”‚ efectivo                   TEXT                                     â”‚
â”‚ tarjeta_dÃ©bito             TEXT                                     â”‚
â”‚ tarjeta_crÃ©dito            TEXT                                     â”‚
â”‚ tarjeta_clave__banistmo_   TEXT                                     â”‚
â”‚ vuelto                     TEXT                                     â”‚
â”‚ total_pagado               TEXT                                     â”‚
â”‚ descuentos                 TEXT                                     â”‚
â”‚ merged                     JSON                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Relaciones
```
invoice_header (1) â”€â”€â”€ cufe â”€â”€â”€ (N) invoice_detail
                   â””â”€â”€â”€ cufe â”€â”€â”€ (N) invoice_payment
```

**Nota:** NO hay FK explÃ­cito `invoice_header_id`, la relaciÃ³n es por `cufe`

---

## ğŸ“ˆ MÃ‰TRICAS DE EXTRACCIÃ“N

### Header (27 campos totales)
```
âœ… ExtraÃ­dos:    14 campos (52%)
âŒ No extraÃ­dos:  1 campo  (4%)  - auth_date
âš ï¸ No guardados: 13 campos (48%) - campos de usuario + metadatos
```

### Detail (12 campos totales)
```
âš ï¸ Mock/BÃ¡sico:  12 campos (100%)
âŒ ExtracciÃ³n real pendiente
```

### Payment (12 campos totales)
```
âš ï¸ Mock/BÃ¡sico:  12 campos (100%)
âŒ ExtracciÃ³n real pendiente
```

---

## â±ï¸ TIEMPOS PROMEDIO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OperaciÃ³n                              â”‚ Tiempo   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fetch HTML (network)                   â”‚  500ms   â”‚
â”‚ Parse HTML + ExtracciÃ³n                â”‚  100ms   â”‚
â”‚ VerificaciÃ³n duplicados (âŒ falla)     â”‚   10ms   â”‚
â”‚ Inserts en BD (âŒ fallan)              â”‚   50ms   â”‚
â”‚ ConstrucciÃ³n response                  â”‚    5ms   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TOTAL (con errores)                    â”‚  665ms   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ PUNTOS CLAVE

1. âœ… **ExtracciÃ³n funciona** - Se obtienen datos del HTML correctamente
2. âŒ **Guardado falla** - Queries SQL con nombres/tipos incorrectos
3. âš ï¸ **Success falso** - Endpoint puede reportar Ã©xito aunque falle el guardado
4. âš ï¸ **Datos perdidos** - 16 campos no se guardan aunque existan
5. ğŸ”„ **Mock data** - Details y payments usan datos de ejemplo, no reales

---

**Ver documentos relacionados:**
- `DATABASE_SCHEMA_ANALYSIS.md` - AnÃ¡lisis detallado
- `CORRECTION_PLAN_PROCESS_FROM_URL.md` - Plan de correcciÃ³n
- `EXECUTIVE_SUMMARY_URL_PROCESSING.md` - Resumen ejecutivo
